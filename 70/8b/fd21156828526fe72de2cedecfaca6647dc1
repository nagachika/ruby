timer thread を廃止するという内部的には特大の変更です。あまりちゃんと読めてない
のですが、まず timer thread を起動することはなく、定期的な preemption は
rb_vm_t::gvl::timer というのが追加されていて、GVL 獲得待ちの thread のうち 1つ
が timer thread のかわりになるようになってて、一定時間で wakeup して割り込みを
かけるようにしています。なんだけど、これだと2つの Thread がブロックせずに実行を
続けてる場合に定期的に切り替わらないんじゃないかな…? またシグナル処理は timer
thread がなくなったのでその他の thread で sigmask を外して直接シグナルハンドラ
を実行してメインスレッドにイベント送信するようになってて、そのため少し前の
SIGCHLD の処理の変更のための仕組みもちょっといじられています。このシグナル処理
もだいじょうぶなのかなぁとちょっと心配ですね。大丈夫かなぁこれ…という感じです
が今日はこの後このコミットの追加修正がしばらく続いています。たぶん安定させるま
でしばらくかかるでしょう。 [ruby-core:88088] [Misc #14937]
