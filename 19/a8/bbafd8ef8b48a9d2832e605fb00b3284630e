Dir.glob で fd がプロセスの開ける fd 数上限に達した時に GC して fd の回収を試み
ることをチェックするテストで、後で close するために配列に IO を保存しておいて
ensure で閉じるようにしてるんですけど、これだと GC されなくなっちゃうからだめな
んじゃないかな。それにここは子プロセスで実行しているので。テストが
Errno::EMFILE でこけてるので setrlimit の設定がおかしいのかな…。と思ったけどよ
くみると open するところは最初に Errno::EMFILE が発生するぎりぎりまで実施するよ
うにしているので、または保守的 GC なので偶然 IO が GC で回収されない状態になっ
てしまったか、ということではないかなぁ。Enumerable#map は内部的に Array オブジ
ェクトを作ってそこに要素を詰めていきますが、この内部的に確保された Array は途中
で例外発生して抜けたら不要になりますが要素を持ったまま GC されるのを待つわけで
すが、たまたまこの 1つの Array が回収されなかったら、この Array に入ってる全要
素も参照されていると判定されて回収されないので、このブロック内で開いた IO 全部
が回収されないという悲劇が起きるのではないかなぁ。
