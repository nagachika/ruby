Hash#each の終了時の rb_ensure() で実行される終了処理の hash_foreach_ensure()
で、Hash のイテレーション中の要素追加などを抑制するためにイテレーションのネスト
具合をカウントしている RHASH_ITER_LEV() の値をデクリメントしていたのを、単にデ
クリメントするのではなくてイテレーションに入る前に保存しておいた値に戻すように
しています。これは callcc で Hash#each のブロックの中の Continuation を作って再
実行すると hash_foreach_ensure() を再実行してしまうためカウンタがダウンフローす
ることによる不具合を対応しているそうです。 Continuation ツラいですね…。これ、
マルチスレッドの場合を考えるとこの方法も問題があるような気がします…。
[ruby-dev:47803] [Bug #9105]
