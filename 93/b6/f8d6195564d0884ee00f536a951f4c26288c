rescue 節の例外の指定に Module 以外のオブジェクトを置いてもエラーにならないとい
う問題を修正するために、YARV の InstructionSequence に新しい命令 checkmatch を
追加して、そのかわりこれまで case 文の when や rescue 節の例外のマッチに使って
いた checkincludearray という命令を削除しています。 checkmatch はスタックから目
的のオブジェクトと比較対象のオブジェクトを取り出し、比較対象が配列だったらその
配列内に Object#=== でマッチするオブジェクトが存在するか、配列でなかったらその
比較対象自体とマッチするかを判定する命令で、さらにオペランドのフラグで指定され
ると比較対象が Module 型でないと例外を発生させるようなことをしています。
[ruby-core:35364] [Bug #4438]
また命令の削除/追加という大きな変更があったので InstructionSequence のメジャー
バージョンを増やして 2.0 にしています。 ISeq をダンプして保存して遊んだりしてい
た人は互換性がなくなるので注意しましょう(そんなに居ないと思うけど)。
