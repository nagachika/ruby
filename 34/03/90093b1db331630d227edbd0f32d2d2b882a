マシンスタックのオーバフロー検出は完全ではなくて稀に SEGV することがあることが
以前より知られていますが*1、チェックのための struct rb_vm_tag をリストに繋げる
前に setjmp(3) を呼ぶようにしています。 setjmp() もオーバフローを置こす可能性が
あり、その時に既にタグがリストに繋がれているとオーバフローした状態に戻すことに
なるので結局 SEGV してしまっていたようです。このため rb_vm_tag のリストとそこに
格納されている jmpbuf の関係が TH_PUSH_TAG() から TH_EXEC_TAG() までの間だけ中
途半端なことになっているので内部を弄る人にとっては注意が必要そうです。これ絶対
別の人がうっかり間違えてギャーってなりますね。 [ruby-dev:47804] [Bug #9109]
これでもうスタックオーバフローで SEGV は起きなくなるんでしょうか?
