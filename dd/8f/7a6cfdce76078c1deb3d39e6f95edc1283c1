io.c で IO.read に引数で読み込み結果を格納するバッファとして String オブジェク
トが指定された場合に読み込みのあいだその String の操作を排除するため
rb_str_locktmp() という簡易的なロックを使っていたのですが、これが例外などの大域
脱出を考慮していなかったので rb_str_locktmp_ensure() というコールバックを渡す形
式の API を追加してこちらを使うことで後始末をちゃんとするようにしています。素晴
しいですね。 [ruby-core:56121] [Bug #8669]
