IO#reopen で先に元々の file descriptor を close(2) してから rb_sysopen() で新た
な file descriptor を開いていたのですが、 rb_sysopen() は GVL を解放するため、
この間に他のスレッドで Ruby スクリプトが動くことができ、close された fd を持つ
中途半端な状態の IO オブジェクトが見えてしまう可能性があったので、まず
rb_sysopen() で fd を開いておいてから rb_cloexec_dup2() で fd の入れ替えをして
その後古い fd を close() するように処理の順序を修正しています。よくこんな細かい
ところに気がつきましたねー。元となるパッチの提供者は数年来こういうコアな部分の
不具合報告やパッチの提供をしている Eric Wong さんです。コミッターになるようにす
すめているけど本人が断わってるんですよね。 [ruby-core:57943] [Bug #9036]
