IO の書き込みの処理を行なう io_binwrite() で出力する前に割り込みをチェックする
ことで、出力処理する前に割り込みが優先して入るようにしています。おもしろいのは
テストで、Thread.async_interrupt_timing(:on_blocking) を使って確実に IO の前に
なるまで非同期例外が遅延されるようにしているので、この挙動のテストが書けるよう
になっています。Thread.async_interrupt_timing ができる前は非同期例外はメソッド
の出入りなど全ての割り込みポイントで割り込まれる可能性があったのでこういうテス
トが書けなかったと思います。 Thread.async_interrupt_timing の使いどころはどんな
ことかなと思っていましたが、ruby のテストを書くのに便利なんですね!
