r56694 の修正部分のリファクタリング。条件分岐を整理してわかりやすくしています。
[ruby-core:78073] [Bug #12920]
