1.9 には RubyGems が組込みになっていますが、RubyGems を常にロードしてしまうと起
動が遅くなってしまうため gem_prelude というインタプリタに埋め込まれたスクリプト
でいろいろ頑張って require をラップしたりして遅延ロードするようにしていた(と思
います。昔ちょっと調べただけなので詳細はあやふや)のですが、最新版の RubyGems
1.4 がこの gem_prelude と互換性がなくなって trunk で動かなくなっているというの
を発端にして、gem_prelude は単に require "rubygems" するだけになっています。ま
た --disable-gems を付けるとこれを抑制できるのでテストのいくつかに
--disable-gems オプションを付けて起動するように追加しています(全ては網羅してい
ないです)。あと WEBrick のテストの変更は直接関係なさそうですが混ざっているみた
いです。
しかしこれで起動がかなり遅くなったようです
% time ruby -ve ""
ruby 1.9.3dev (2011-01-12 trunk 30527) [x86_64-darwin10.6.0]
ruby -ve ""  0.01s user 0.00s system 89% cpu 0.020 total
% time ruby -ve ""
./ruby-trunk -ve ""  0.30s user 0.03s system 47% cpu 0.706 total
何度か繰り返してみるとだいたい 20倍から30倍くらいになっているようです。make
test-all も子プロセスとして起動するものが多いみたいで遅くなったような気がします
。
[ruby-core:34478] あたりを読むと、最新版で動かなくなるのはまずいからとりあえず
動くようにして遅いのはこれからまた早くする方策考えればいいでしょ、みたいな感じ
でそれはそれで動くようになればいいのですが、まだちょっと怖くて RubyGems アップ
デートしていません。リリース版については多くのユーザが結局 RubyGems を使うと思
うので動くようにならないとまずいですが trunk を日常的に使っているのは主に開発者
のような気がするので、この修正の処遇はどうなるでしょう。反対意見も出てるようで
すし。
あとこれを入れてから test/ruby/test_dir_m17n.rb で WARNING が出るようになりまし
た。bundler.gemspec が UTF-8 の文字を含んでいるのに、テストで default_internal
を EUC-JP にして起動するものがあるためです。とりあえず --disable-gems を入れて
回避してみましたがこれもどうするのか。テストのあちこちに --disable-gems を入れ
てまわることになるんでしょうか。
