r31755 ではバッファにエンコーディング未変換のバイトが残っているかどうかを区別し
ていなかったので戻り値を条件分岐するようにしています。
