標準添付ライブラリ timeout.rb がタイムアウト時に例外を投げて処理を中断させてい
たのを、throw-catch の大域脱出を使って Timeout.timeout のブロック内を抜けさせて
、例外は Timeout.timeout のところから指定された例外を発生させるようにしています
。
これは例外発生時に Exception#exception メソッドを呼ぶことを利用して、デフォルト
で利用される Timeout::ExitException#exception で throw を投げることで
throw-catch を使うように実装をすりかえるようです。トリッキーですねー。ブロック
内でタイムアウト時に指定の例外が発生することを期待している場合もあるのでは……
と思いましたが、例外クラスをライブラリの外から指定した場合はこれまでと同様に例
外で抜けるので、そこは問題なさそうです。
[追記]と、思ったのですがやっぱり常に throw にすりかえになっていました。r42710
でここに書いたように例外クラスが指定された時にはその例外発生になるように戻され
ていました。[/追記]
Timeout::ExitException を内部でわざと rescue するようなことをしていると期待した
ように動かなくなるかもしれませんけど、これは rescue Exception と全ての例外を捕
捉してしまっているような時に Timeout の例外も捕捉してしまう問題に対する対処であ
るのでやむを得ないかなという感じです。 rescue Exception なんてする時点で自分で
責任持ってねって言いたいですけど(Kernel#exit の SystemException とか Signal と
か InterruptedException とかも飛んでくるわけなので)。と思ったらチケットのほうで
は nobu さん自身 rescue Exception しているのが問題として一旦 Reject しています
ね。 [Bug #8730]
