CRuby のオブジェクトのメモリ管理の構造はおおざっぱに heap -> page -> slot
(struct RVALUE) という階層構造になっていて、オブジェクト1つが配置される slot の
配列状の領域がいくつかリスト(やソート済みのインデックスなどで)で管理されている
heap がプロセス全体で(ObjectSpace で)1つ存在するという実装でしたが、構造体のレ
イアウトを少し変更して、heap を複数に分けて持つことができるようにしています。
rb_heap_t という構造体を struct heap から分離して、現在のところは eden_heap と
いうメンバ名で唯一の heap を持つようにしているので、実質はあまり変更はありませ
んが今後これを増やすことができるように準備しているという感じです。
Twitter でささださんとまつもとさんがやりとりをしていましたが、将来的に GC で回
収されにくい長寿な(という傾向があると判っている、Symbolなど)をある heap にまと
めて置いて、そこは RGenGC の minor GC では回収しないことにするなどで sweep のコ
ストを低減しようということのようです。 https://twitter.com/_ko1/status/
392642087234977794
