rb_method_call() で $SAFE の最大値(4)をコード内に直に記述していたのでコメントを
つけて変数として宣言してそれを使うようにしています。定数マクロは safe.c では
SAFE_LEVEL_MAX として定義されているのですが、ソースファイルに直接書かれてるので
他のソースからは使えないんですね。しかし他にも array.c hash.c などなどあちこち
に同じような rb_safe_level() < 4 というコードがあるので、ヘッダにもっていくかチ
ェックそのものをマクロ化するのがよさそうですね。
