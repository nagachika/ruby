Thread 内で ensure 節で sleep するようなコードがあるとプロセス終了時の
rb_thread_terminate_all() で各 Thread を一度だけ kill してから終了を待つのに
rb_thread_schedule() をはさんで待つためビジーループ状態になるので、native_sleep
() を使って CPU 時間を食わずに待つようにして、終了したスレッドはメインスレッド
に割り込みを送って起こすようにしています。とりあえず CPU を使わないようにしただ
けで、プロセスが止まらないのはそのままとなっています。この先どうするかはチケッ
トでさらに議論(というかまつもとさんの意見)を待つようです。 [ruby-dev:44546]
[Bug #5368]
