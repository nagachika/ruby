かつて YARV と呼ばれていた 1.9 からの Ruby VM の命令にはメソッド定義のための
definemethod と definesmethod(三単現のs じゃなくて singleton method の略で
define + smethod ですね)という命令があったのですが、今は内部的な FrozenCore と
いうオブジェクトの特異メソッドとして実装されていて、メソッド定義はメソッド呼び
出しで行なわれるという感じになっています。これは stack caching などの VM 最適化
の手法を使うために VM 命令の数を小さく保とうという動機があったためとのことなの
ですが、今はもうそういう手法は採用しなさそうで、逆にメソッド定義が VM 命令にな
っていないために最適化が難しいというのもあってこれらの VM 命令を復活させていま
す。逆にメソッド定義のためのメソッドに ISeq を渡すための命令 putiseq は消してい
ます。
個人的に stack caching は Ruby の実装を読む勉強会で YARV の最適化を読む時の題材
にしたので懐しいですね。
