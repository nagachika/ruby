ruby_xmalloc()/ruby_xfree() などのメモリ確保/解放の関数は確保済み領域のサイズを
引数に渡して malloc 等で確保されたサイズを管理できるようにした wrapper 関数
ruby_sized_realloc() や ruby_sized_xfree() というのを使っていましたが、r43760
あたりで導入した malloc_usable_size(3) が使える場合はこれを使うことで確保したサ
イズを取得するようにしています。ただし外部に提供する API としての関数定義は残し
てあります。 internal.h でマクロとして定義することで内部では置換されるようにし
ているようです。また array.c や string.c で直接 ruby_sized_xfee() を呼び出して
いたところを ruby_xfree() を使うように変更しています。マクロ利用時に未使用のロ
ーカル変数の警告が出るようになってしまうため(size 用の変数が使われなくなってし
まうので)。
