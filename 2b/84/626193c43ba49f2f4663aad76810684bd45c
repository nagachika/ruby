String#encode や encode! でエンコード変換で文字列が変化しなかったらエンコーディ
ングの設定のみ変更して返すようにしています。エンコーディングに対して不正な文字
を含む文字列を encode で同じエンコーディングに変換すると String#valid_encoding?
が true に戻ってしまう不具合を修正しています。 [ruby-core:43557][Bug #6190]
