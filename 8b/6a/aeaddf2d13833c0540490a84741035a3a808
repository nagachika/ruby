標準添付ライブラリ irb の IRB::RubyLex#set_input で最後の改行がなかった時に残った token を解析してインデント数などを得てプロンプト表示に使うようにしています。プロンプト生成を最適化したからペーストとかで複数行を一度に貼りつけた時に正しく処理されない場合があったとかかな。
