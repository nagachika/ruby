string.c に NUL 文字を '\0' として 1byte でチェックするのではなくて、ちゃんと文
字として(マルチバイト文字の場合は複数バイトになる可能性もあるので)確認する関数
str_null_char() を追加して rb_string_value_cstr() でマルチバイト文字のありえる
エンコーディングの時はこれを使って NUL 文字チェックを行なうようにしています。
んー、ということはエンコーディングを考慮した NUL 文字は含まれていないけど、char
* 型の C の文字列としては途中に '\0' が含まれているような文字列が取れる可能性が
あるってことになって、StringValueCStr() に期待されている前提が崩れるような気が
するのですが……。そこはちゃんとエンコーディングを意識してあげないといけないと
いうことでしょうね。
