BigDecimal の coerce のエラー時の処理で例外メッセージのために rb_inspect() で生
成した String オブジェクトをそのまま RSTRING_PTR() で C の文字列を取り出して利
用していて、コンパイラの最適化によっては GC から保護されないようになっていたの
で、String オブジェクトの操作で例外メッセージを生成して rb_exc_raise() を呼ぶよ
うに修正しています。 [ruby-core:38862] [Bug #5172]
rb_special_const_p() が真の時の rb_inspect() は常に新しい String だと思うので
rb_str_dup() はしなくても大丈夫じゃないかな、とも思いますが将来に渡って安全のた
めにはいいのかもしれません、例外発生時だけですしそんなにパフォーマンスを気にし
てもしかたないですし。
[追記] to_s を再定義してしまって同じ String オブジェクトを返すようにすると dup
する必要があるということでした。なるほど……[/追記]
