Thread#thread_variable? というメソッドで渡された Symbol が thread local variable に登録済みかのチェックに一旦 ID を経由していたので GC されない symbol (たしか immortal symbol っていうんだっけ。コミットログでは pinned symbol と表現されている)にのみ有効だったので、オブジェクトをそのまま Symbol に変換して渡すようにしています。変更前のテストをみると Thread#[]= で immortal 化しないようにするのは意図的で、thread_variable? でチェックする際に渡す Symbol は dynamic (かつ mortal) かもしれないのでその場合も動くようにしたということかな。 [ruby-core:98480] [Bug #16906]
