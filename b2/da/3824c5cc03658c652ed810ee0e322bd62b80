文字列リテラル内の式展開の中で呼ばれる暗黙の to_s による文字列化に Refinements
による to_s メソッドの再定義が効かなかったのを効くようにしています。send 命令で
の明示的なメソッド呼び出しをするようにしているのですが、そのままだと遅くなって
しまうので、このために VM 命令に branchiftype という命令が追加されていて、オブ
ジェクトの型が T_STRING だったら to_s の呼び出しが不要なので VM 命令レベルで分
岐して、余分なメソッド呼び出しが抑制されるようにしています。String#to_s が再定
義されてた時は…というのはまあいいのか(元から文字列だった時に to_s 相当の処理が
呼ばれるのかどうかははっきりしていない気がする)。 [ruby-dev:50200] [Feature #
13812]
