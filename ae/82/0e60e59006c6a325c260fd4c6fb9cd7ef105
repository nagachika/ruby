拡張ライブラリ socket で socket(2) および socketpair(2) の flags に O_CLOEXEC
が渡せるかどうかを errno=EINVAL のエラーがかえってくるかどうかで判定して、渡せ
なかったらあきらめて O_CLOEXEC なしで呼ぶという処理を毎回していたのを、一度実行
した結果を憶えておいて次回からは無駄なシステムコール呼び出しをしないようにして
います。またエラー時にそれが実際に O_CLOEXEC の指定のせいなのかを fcntl() の
F_GETFD でフラグを取得して判定することで正確に O_CLOEXEC の指定でエラーになった
ことを検出するようにしています。いつもコアなパッチを送ってくる Eric Wong さんの
パッチです。すごいなー。 [ruby-core:59429] [Feature #9330]
