YARV の VM 評価ループの実装方法にはいくつかあって、そのうち
OPT_CALL_THREADED_CODE という各命令の処理を関数ポインタとして持っておいてそれを
呼ぶという比較的素朴な実装の時の一番底のスタックフレームから抜ける時に値を返せ
なかった問題を修正しているようです。 direct threaded という方法だと各命令はルー
プ*1内に展開されるのですが、 OPT_CALL_THREADED_CODE だと各命令が関数になるので
leave 命令において return で VM のメインループから抜けることができないため未対
応とされていました。 rb_thread_t::retval に戻り値を格納することで値を返せるよう
にしています。
