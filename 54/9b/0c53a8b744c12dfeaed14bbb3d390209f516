[ruby-dev:42350] で報告された、set_trace_func でセットした Proc オブジェクト内
で set_trace_func(nil) でフックが削除されると SEGV する不具合の修正。イベントフ
ック処理中にイベントをすぐに削除せずに、削除予約のマークをつけてスキップし、後
で回収するようにしています。
remove_defered_event_hook でリストの先頭が書き変わるかどうかをチェックしている
方法(削除されない要素があったら root を変更しておく)が最初わからなくて一瞬バグ
かと思いました。
