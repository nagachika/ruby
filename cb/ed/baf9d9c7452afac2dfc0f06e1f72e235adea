標準添付ライブラリ net の Net:Protocol#read と #read_all で読み込み用のバッファ
の String オブジェクトに読み込んだ文字列を String#<< で追加する前に read_bytes
を増加させておくようにしています。どうせすぐ増やすのにそこまで厳密さいるのかな
と思ったけどテストコードをみると ruby で実装されているので、その隙間で Thread
のスイッチがおきて、しかもバッファ用 String オブジェクトは呼び元で渡せるのでそ
れを操作されると期待したサイズの増加ができない可能性があったようです。なるほど
。
