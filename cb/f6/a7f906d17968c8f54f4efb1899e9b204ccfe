標準添付ライブラリ irb の IRB::RubyLex#ripper_lex_without_warning で Ripper::Lexer#lex が空配列を返すまで繰り返し呼ぶようにしています。といっても通常1回で最後までの token をまとめて返すので、実際にはエラーになって欲しいのにエラーにならないケースで irb のブロックのネストが解除されない不具合修正のため空配列が返ってきたら抜けるようにするためみたいです。 [Feature #17276] の修正で Ripper::Lex が SyntaxError になるスクリプトでも最後まで token を返すようになったのに関係してるみたいですが、たぶんそっちが直ればこの変更は不要だったのでしょう(けど独立した gem としてもリリースされるので古い ruby のために必要)。 https://github.com/ruby/irb/issues/38
