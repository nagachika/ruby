st_update() で st_table の内容を更新する時に key として引数に渡したものを格納し
なおしていたのですが、 require のロックのために利用していたところで st_update()
に渡した文字列のメモリが解放される可能性がありました。 st_update() は引数に渡し
た key ではなくて、元々 st_table に格納されていたほうの key を再度利用するよう
にしています。 st_update() は元々対応する key が存在しなかったら新たに追加する
ので、その時は引数の key が利用されるわけで、key が常に検索のためだけに利用され
るわけではなく st_update() に渡す key は解放してもかまわないと言いきれないので
すが、そもそも st_table はそういう使われかたを想定していないと思うので require
ロックのほうにコメントされていたほうがいいような気がします。 [ruby-core:49220]
[Bug #7330]
