io.c に rb_gc_for_fd() という主に fd の数が飽和した時に GC を実行するための
errno の判定と rb_gc() 呼び出しをまとめた関数を作り、ruby_dup() や rb_sysopen()
、rb_fdopen()、rb_pipe() などの関数でこれを使うようにすることで一貫した処理を行
うようにしています。 EMFILE, ENFILE の他に ENOMEM がかえってくることもあるとい
うことでそれもチェックに追加しています。もうひとつの狙いとしては errno は TLS
として実装されていて、ただのローカル変数の参照よりもコストが高い可能性があるの
で、関数の引数に渡すことで errno は一度だけ参照してあとはローカル変数(引数です
が)として使いまわすことで最適化するという狙いもあるようです。まあでも関数呼び出
しのコストはどうなんだろ…。 [ruby-core:71623] [Feature #11727]
