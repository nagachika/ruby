メソッド呼び出しの引数の準備で ARRAY_ASET() を使ってたのを rb_ary_push() を使って詰めるようにしています。サイズの調整が……と思ったら元から length=0 のまま要素を詰めてしまってたみたいですね。 rb_ary_tmp_new() の引数は capa の初期値なので len は 0 のまま。 正しく参照が辿れないため GC.compact でエラーになって発覚したみたいです。
