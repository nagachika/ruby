Thread が GVL を解放してブロックする可能性のあるシステムコールなどに入っている
のを割り込みをかけて起こすための ubf_select() で、起こすための SIGVTALRM は喪失
の可能性がある(GVL 解放後実際にシステムコールに入る前に受け取るかもしれない)の
で、タイマースレッドが管理している起こすべきスレッドリストに入れて、タイマース
レッドが寝ていた時のために rb_thread_wakeup_timer_thread() を呼ぶようにしていた
のですが、FreeBSD 9 でシグナル受信時にタイマースレッドがメインスレッドに(シグナ
ルを処理させるため)割り込みをかける時にもこれが呼ばれて、タイマースレッド自身を
起こす(パイプに書き込む)のでタイマースレッドがずっとビジーループ状態になってし
まうという現象が起きていたため、ubf_select() での rb_thread_wakeup_timer_thread
() の呼び出しはタイマースレッド以外のスレッドから呼ばれた時だけにするようにして
います。 [ruby-dev:44985] [Bug #5757]
なのですが、kosaki さんの指摘のように、シグナル処理させるためのメインスレッドへ
の割り込みにもレースがあるかもしれないので、タイマースレッドが polling mode を
やめて無期限に止まるのを避けるようにしないといけないかもしれません。
