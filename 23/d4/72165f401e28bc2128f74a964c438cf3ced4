r33282 を revert しています。
チケットみると自分が i686 でのテストの失敗を報告してた件ですね。それをみて思い
出いましたが、この問題は x86 系の古い CPU だと浮動小数点数演算を x87 FPU (Intel
8087 とその子孫達)というコプロセッサで行なっていて、この FPU では浮動小数点数の
レジスタが 80bit あってメモリ上での 64bit の表現と異なるために誤差の違いが生じ
るということによるものです。 gcc では -ffloat-store というオプションを付けると
、必ず演算するたびに一旦メモリに値を戻して 64bit 表現に変換するようにするので回
避できるはずなのですが、r33282 はこれを変数に格納することでやろうとしているらし
く、そのような対処は当然コンパイラの最適化によって無視される可能性があるのであ
んまり意味がありません。FPU の 80bit のレジスタ上で演算が繰り返されてしまうと演
算結果に差が生じるためです。チケットの報告をみるとたまたまうまくいった時があっ
たみたいですが、最適化オプションをつけるとだめみたいです。またチケットには
naruse さんと usa さんのコメントで FPU の問題の解説とか、-ffloat-store のかわり
に -msse2 でもいい(ただし当然 SSE2 が利用できる CPU でないとだめ)とか、VC の場
合は -Op や -fp:precise といったオプションがあるというような説明もあるので気に
なる方はそちらも見てみてください。
