File.expand_path や File.basename, File.dirname, File.join などなど、ファイルパ
スを扱う File、Dir のクラスメソッドや Pathname#sub_ext で文字列のエンコーディン
グを意識した処理をするようにしています。 [ruby-dev:45145] [Bug #5919]
主にパスの区切り文字(/ とか \)の探索や拡張子の検出で1文字ずつ辿るところが1バイ
トずつの処理になっていたのを、エンコーディングを意識して1文字ずつの処理にしたり
、あとは途中にヌルバイトが存在する可能性があるのを考慮した(?)ループの停止条件な
どの変更です。
chompdirsep() などで path++ が残っているので区切り文字はシングルバイトであるこ
とは仮定されているようですね。Windows では UTF-16 だったような……と思って
Rubyist Magazine - Ruby M17N の設計と実装のファイルパスのエンコーディングについ
て読むと[DEL:Rubyが利用している:DEL]ANSI版APIは ANSI コードページまたは OEM コ
ードページなるものに変換した文字列を返すとのこと。これらが実際にどんなエンコー
ディングなのかははっきりわかりませんでしたが……。
[追記]コメントで教えていただきました。1.9.3 以降は Win32 API の ANSI 版ではなく
て Wide文字版を利用しているそうです。しかしシステムネイティブのエンコーディング
(多分 UTF-16LE)から Encoding.default_external に変換して Ruby 内には入ってくる
ので default_external が ASCII-compatible エンコーディングなら大丈夫、というこ
とでしょうか。[/追記]
