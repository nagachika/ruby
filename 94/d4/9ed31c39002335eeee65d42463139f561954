2038cc6cab6ceeffef3ec3a765c70ae684f829ed で拡張ライブラリ socket の名前解決で getaddrinfo_a(3) を使って割り込み可能にした影響で Socket.getaddrinfo と fork を組み合わせるとうまく動かないという不具合を修正。 getaddrinfo_a(3) は内部で pthread を利用していて、fork 時に全ての thread を止める処理の対象になっていないためこれが残ってしまうという問題があったようです。なので fork 前の全 thread を止める処理で gai_cancel(3) という API を利用して名前解決のリクエストをキャンセルして、全てのリクエストが終了するまで待つことで thread がなくなるのを待つようにしています。[ruby-core:100329] [Bug #17220]
