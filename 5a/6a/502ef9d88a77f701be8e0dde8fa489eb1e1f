r53850 からの一連の変更の再修正。ワイド文字のエンコーディングの終端文字のバイト
数を考慮するように確保するバッファのサイズを計算するようにしています。また可能
なら REALLOC_N() を使ってバッファの再確保をするようにしています。
