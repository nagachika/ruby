スタックオーバフローの時に SystemStackError を発生させるための処理の Mac OS X
での対応です。 Mac OS X ではスタックオーバフロー時に SIGSEGV ではなく SIGBUS が
発生するので、sigbus でスタックオーバフローチェックを行うようにして、SIGBUS の
シグナルハンドラも sigaltstack() で専用のスタック領域を利用するようにしています
。またオーバフローの検出も Mac OS X ではスタックの最後に検出用の guard page と
いう領域があってそこにスタックポインタが突入するとシグナルが飛ぶようになってい
るので、それを考慮してオーバフロー検出するようにしています。
pthread_attr_getguardsize() という API があってスタックの最後にどのくらいの
guard page 領域が用意されているか取得できるんですね。 [ruby-core:24540] [Bug #
1813]
