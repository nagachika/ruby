drb/ssl のテストでエラー時に子プロセスが残る問題について、子プロセスを waitpid
している Thread (Process.detach すると waitpid するだけの Thread が生成されま
す)を憶えておいて dRuby サービス停止時に子プロセスにシグナルを送信するようにし
ています。これは知らなかったのですが、Process.detach で作られた Thread には pid
という特異メソッドが定義されていて、待っている子プロセスの pid が取得できるんで
すね。また spawn する時に配列を渡すことでシェルを介さずに直接rubyプロセスをexec
することで、シグナル受信で確実に殺せるようにしています(シェルを介するとシグナル
でシェルだけ死んでしまって孫になる殺したいrubyプロセスまで届かない)。
[ruby-dev:45547]
