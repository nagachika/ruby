exec/spawn などで timer thread が利用している pipe と同じ fd を IO の付けかえ先
に指定された時のために fd をすげかえるように r51268 で対応されていまいたが、こ
れは revert して、 spawn/exec の時に常に timer thread を停止するようにして、そ
の際に利用している pipe の fd も close するため結果として fd のすげかえは不要な
ものとしています。またこの際 timer_thread_pipe の構造体に writer というメンバで
操作中のカウンタを入れることで排他処理をしています。また、timer thread への停止
の通知は pipe の close で通知するようにしています。あと timer thread の停止でな
にかエラーが発生したら異常終了するようにしていましたが、rb_warn() で警告を出力
して続行するようにしています。コミットログにこの点についてはコメントされてます
が、どういう意味かよくわからなかったです。 [ruby-core:70386] [Bug #11336]
なお timer thread を全てのプラットフォームで止めるようにするのは r51209 で行な
われて、シグナルの喪失があるということで r51268 で revert されているのですが、
多分この点は考慮されているものと思います。
