Net::HTTP でサーバとの接続を保持したままリクエストを送信する場合、サーバ側でタ
イムアウトして接続を閉じられてしまったために read に失敗することがあり、その場
合 GET, HEAD など繰り返し実行しても問題ないリクエストの場合は自動的にリトライす
るべきらしいので EOFError, Errno::ECONNRESET が発生したら一旦ソケットを閉じて再
接続して 1度だけリトライするようにしています。ちなみに DELETE も IDEMPOTENT な
リクエストなんですね。 POST だととりあえず例外がそのまま発生するようになってい
ます(ただし後述のように Net::HTTP 側もタイムアウトを持つようになっているので、
絶妙なタイミングで close されたソケットから読む可能性はのこっているものの、繋げ
っぱなしの Net::HTTP を時間を空けて使い回すぶんには大丈夫になっているはずです)
。 [ruby-dev:45030] [Bug #5790] [ruby-core:41821] [Bug #5813]
また Net::HTTP のクライアント側でもタイムアウトの設定を持つようにして、リクエス
トを送信する時に前回の通信から一定時間が経っていたら接続しなおすようにしていま
す。デフォルトのタイムアウト時間は 2秒になっています。 Net::HTTP#
keep_alive_timeout= で秒単位で設定できるようになっています。
