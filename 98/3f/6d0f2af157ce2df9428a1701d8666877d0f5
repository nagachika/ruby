ractor.c の ractor_next_id() で ractor_last_id をインクリメントして新しい id を返してるところで RB_VM_LOCK()/RB_VM_UNLOCK() による排他処理をしていましたが、これは RUBY_ATOMIC_FETCH_ADD() マクロによる atomic 操作で良いだろうということでこれに置き換えてます。これ系の atomic 操作のマクロってコンパイラとかアーキテクチャがサポートしてない時に効果がない書きかたに fallback することがあったような気がしますが、調べてみるとそういえば 20773a109029ba4464d7749d38a311f880a73293 でそのような場合はビルドエラーになるようにしていたのでした。
