tool/ruby_vm/views/mjit_compile.inc.erb で MJIT によるコード生成時に leave 命令および opt_invokebuiltin_delegate_leave 命令の処理で割り込みを検出した場合に goto cancel していたのをやめその場で rb_threadptr_execute_interrupts() を呼び出して割り込み処理して VM control frame の pop を続けるようにしています。 cancel で通常の vm_exec() に fallback するのは leave 命令の時はよいけど opt_invokebuiltin_delegate_leave 命令の場合は builtin 関数の呼び出しからの return の処理でこの場合重複して builtin 関数が呼び出されてしまうことになるのでまずいとのこと。ふーむ、なんで leave では大丈夫だったのかな。
