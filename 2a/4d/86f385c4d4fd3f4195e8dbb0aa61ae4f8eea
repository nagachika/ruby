io.c に internal_write_func2() という関数を追加しています。これは
rb_thread_call_without_gvl2() という割り込みチェックをさきにして割り込まれてた
ら GVL 解放した処理に入らないようにする API を利用するようにしたものです。そし
て IO#write はこれを利用するように変更されています。この変更はシグナルのトラッ
プハンドラ内で IO を使うと(puts など)メインスレッドで出力のため IO の個別の描き
込みロックを取得した状態でトラップハンドラに入り、そこで再度同じ IO に対して書
き込みをしようとして recursive lock で例外発生してしまうという問題の対処みたい
です。とはいえここでは既に io->write_lock はロック取得した後なのでこれは直接の
修正ではないと思います。 [ruby-core:47880] [Bug #7134]
