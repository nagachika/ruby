st.c で実装されている struct st_table は RArray や RString と同様に、要素数が少
ない時は配列の中にキーと値を埋め込んで、数が増えるとヒープから領域を取って格納
するようになっています。st_foreach() は struct st_table の要素を巡回している途
中に要素の追加があって rehash が発生した場合にこの埋め込みの状態からヒープ利用
した状態に遷移したらちゃんと動かないようになっていました。この修正は埋め込みか
ら展開された状態になったらそれに追随するようにしています。
[追記]st_table で埋め込み方式が使えるのは numhash の時だけだったので Hash で使
う時には関係なかったようです。コメント欄参照[/追記]
[DEL:多分 [ruby-dev:43111] のスレッドの関係で修正したのでしょうけど、こっそり直
してるなんて人が悪い^H^H^H奥床しいですね。
なお Hash#[]= 等でしているチェックは殺されていないので Hash#each 中に要素追加で
きないという仕様は変化していません。実装上の障害を取り除いたという感じですね。
:DEL][追記]というわけで直接は関係なかったようです。[/追記]
