openssl で証明書の検証にコールバックを渡して OpenSSL のライブラリから呼ばせてい
ますがそこで例外や大域脱出が発生した場合 OpenSSL の内部を通り抜けて処理が飛ばさ
れるようになっていたため、 OpenSSL 内部での必要な後始末がされていない可能性があ
るという問題がありました。しかたないのでコールバックの Proc オブジェクトの実行
で例外発生時は rb_protect() で捕捉して止めてしまい、警告メッセージを出した上で
そのまま握り潰すようにしています。 [ruby-dev:43274] [Bug #4445]
なるほどー、ネイティブライブラリの wrapper としての拡張ライブラリでコールバック
を扱う時はこういうことに気をつけないといけませんね。ユーザーデータに例外を記録
しておいてライブラリ側の関数から抜けた後で例外を再現させることができれば(あと処
理の中断もコールバック関数の返り値等で指定できれば)いいのでしょうけど、コールバ
ックの仕様が対応できないものだと難しいですね。
