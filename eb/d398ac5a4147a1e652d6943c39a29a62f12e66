構造体メンバー struct RHash::iter_lev を消してそのぶんを reserved に戻し、かわりに flags のうち一部のビットを使って iter_lev の代替にするようにしています。 iter_lev は Hash が each などで iterate 中に検出するためにインクリメントしていくカウンターですが、通常この値はそんなに大きくはならないので int まるまる使わなくてもいいだろってことみたいです。しかしそれでも意図的にネストさせればあふれさせることはできてしまうので、そのような場合のために rb_ivar_set_internal() という API を追加してあふれたら内部的なインスタンス変数を使ってそっちに iter_lev を格納してしまうようにしています。うーむ、この hash_iter_lev を持ってる状態の Hash を Marshal.dump して Marshal.load するとどうなるんだろう。まあインクリメント時に flags のほうをさきに見てあふれたら内部的インスタンス変数のほうに上書きセットされるから動作がおかしくなることはないか。
