r40791 の続きっぽいですが rb_vm_tag 構造体の rb_jmpbuf_t 型のメンバーの宣言位置
を構造体の先頭から retval の後ろに移動しています。そのかわり(?) r40791 でやって
いた jmpbuf に書き込めるかどうかのチェックは消しています。追記されているコメン
トによると、構造体の先頭と最後のメンバが TH_PUSH_TAG() で書き込まれれば構造体の
全てのメンバがアクセス可能になるから、とあるので[DEL:コンパイラの最適化で不要な
メンバはスタック上から省かれてしまうというような恐しいことが起きていたのではな
いかと思われます。最適化こわい。:DEL]
[追記]なかださんに教えていただきました。さすがに最適化そこまでこわくなくて、ス
タックに rb_vm_tag を置いた時にスタックがアドレスの小さい方向に伸びる場合に、他
のメンバはアクセスできるのに buf はオーバフローしてアクセスできないアドレスに配
置されるという可能性があって、TH_PUSH_TAG() では buf にはアクセスしていないので
そのまま push してしまって、その後オーバフロー検出でシグナル受信した時に buf か
ら読もうとして再度シグナルが発生して…と抜けられなくなるという現象が発生してい
たそうです。 [Backport #8380] で起きていてなぜかよくわからないけどリファクタリ
ングで直った TestThread#test_stack_size のタイムアウトもこの理由だったのかもし
れませんね。というわでこれもバックポートが必要、と。[/追記]
