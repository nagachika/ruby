deadlock 検出に race condition があり、複数のスレッドが同時に GVL を取得しよう
としてお互いを不正な状態にあるとして誤って abort してしまう不具合を修正していま
す。発生する race condition の詳細は [ruby-core:46994] を参照。これは
rb_mutex_lock() で deadlock 検出のために最後に一人で lock 取得するスレッドは
ptherad_cond_timedwait() で定期的に起きてチェックするようにしているのですが、こ
こで複数のスレッドが「自分が最後なのでタイムアウトつきで待とう」としてしまって
いるのがよくないようなので、別途 patrol_thread という変数に「最後に lock を取得
するスレッド」つまり「定期的に起床して deadlock チェックする担当のスレッド」を
保持しておくようにしています。 [ruby-core:44275] [Bug #6278]
