r33234 の NoMemoryError を追加するのは revert して、Process.spawn に長い文字列
を渡す前に GC.start を実行して一度 GC を完遂させるようにしています。これは
LazySweep になって sweep が部分的に実行されるので長いバッファを確保しているオブ
ジェクトが sweep 中だったりすると NoMemoryError が発生しやすくなっているという
ようなことがあるんですかねぇ。
[追記]と、いう疑問があったので少し調べたのですが、lazy_sweep を実行するのはオブ
ジェクトのスロットである struct RVALUE を取得しようとして空きがなかった時だけで
、ruby_xmalloc() などでメモリ確保の時に失敗したら sweep を完全に実行する
garbage_collection() を呼んでいるんですよね。従って GC.start を実行しておくのと
だいたい同じことが自動的に行なわれるはずなのですが、はて、なぜこれが効くのでし
ょうか。[/追記]
