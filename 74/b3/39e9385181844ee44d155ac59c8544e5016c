シグナルマスクの戦略変更の修正です。これまで CRuby はタイーマースレッドのみがシ
グナルを受信してシグナルハンドラを実行し(SIGSEGV とタイマースレッドから各ユーザ
ースレッドへの通知用に利用される SIGVTALRM は例外)、シグナルハンドラ内で受信シ
グナルを溜めておいてタイマースレッドがメインスレッドへシグナルを配送するという
「意図」になっていて、タイマースレッド以外はシグナルマスクがかけれられている「
はず」でした。しかし実際には不具合があってシグナルマスクは外れてしまっていて、
どのスレッドでもシグナルハンドラが実行されている状態になっていました。
現在のシグナルハンドラ内の操作は atomic な変数の increment と pipe 書き込みによ
るタイマースレッドへの通知になっていて、複数のスレッドでシグナルを受信しても問
題なくなっているので、逆にこれまでの設計をやめて全てのスレッドがシグナルマスク
を外してシグナルハンドラを実行できるようにしています。 [ruby-dev:43571] [Bug #
4765]
