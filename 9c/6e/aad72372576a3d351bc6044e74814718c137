rb_hash_delete() が Qundef を返す場合があるようになってしまっていたのを修正して
います。 r48114 で rb_hash_delete() はそのコンテキストにブロックがあっても呼び
出しを行わないように変更されていたのですが、キーに該当する値がない時に Qundef
を返すことで判定するようになっていて、posix-spawn などの gem がこの変更の影響で
SEGV するようになってしまっていたそうです。うーむこれは読んだ時に気がついてもよ
さそうなものだったけどスルーしていましたね。 rb_hash_delete() は
rb_hash_delete_entry() という名称にして、rb_hash_delete() は Qundef がかえって
きた時に Qnil を返すようにする wrapper として定義するようにしています。なんでこ
んなややこしいことになっているかというと Hash の値に nil が入っているのと、そも
そもキーがないのを区別するためだと思います。これも ruby で nil があまり特別扱い
されていないから…というやつですね。 [ruby-core:66989] [Bug #10623]
