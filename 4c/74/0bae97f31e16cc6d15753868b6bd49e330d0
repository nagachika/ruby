ruby に DTrace によるプローブを追加しています。 DTrace は(多分元は Solaris で産
まれて) Mac OS X や Free BSD でサポートされているアプリケーションのトレースを取
る機構です。これにより ruby を変更せずに動的にプローブの追加されたイベントを検
出してプロファイル情報を取得できるようになります。 [ruby-core:27448] [Feature #
2565]
今回 Ruby に追加されているプローブは
  • 例外生成
  • GC (開始/終了)
  • GC の mark フェーズ(開始/終了)
  • GC の sweep フェーズ(開始/終了)
  • Hash の生成
  • メソッドの開始、return
  • load (開始/終了)
  • require (開始/終了)
  • require のパスサーチ部分 (開始/終了)
  • オブジェクト生成
  • ruby スクリプトのパース (開始/終了)
  • String の生成
  • Array の生成
などで、その他 INSN の利用頻度の測定を実施している時にだけ呼ばれるプローブ? も
あったりしますがよくわかりません。
一応構想としては https://bugs.ruby-lang.org/projects/ruby/wiki/DTraceProbes と
いうページがありますが、ここに書かれているものよりは多いみたいです。
またプローブを使わない場合のパフォーマンスについては、C の見た目上分岐があるよ
うにみえますが、DTrace が有効でない環境ではこれは単に消えます。DTrace が有効な
環境でもプローブを有効にしなければその部分にいくつか nop が入るだけなのであまり
速度への影響はないのではないかということでした。(参考URL: http://www.atdot.net/
~ko1/diary/201205.html#d13 )
あとコミットログに無関係な ChangeLog のエントリが紛れこんでいるようですね。
