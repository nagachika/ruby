r43942 で Hash の rehash 時に hash メソッドで例外など大域脱出が発生した時のメモ
リリークを rb_protect() を使って修正しましたが、そうではなくて rb_hash_new() で
Hash オブジェクトを作ってそれに st_table を格納して GC に管理させることでメモリ
リークを防ぐ方法に変更しています。 rb_str_tmp_new() でバッファを作る時のような
方針ですね。もちろん処理後は生成した Hash オブジェクトから元の Hash へ st_table
は参照を移動しています。 [ruby-core:58728] [Bug #9187]
