r33157 の class/module 文で Object に include されたモジュール内で定義されたク
ラス/モジュールを再定義する時の挙動の再修正です。 r33157 だと継承したクラスの中
に定義されているクラスやモジュールを見てしまうようになっていたようです。 module
/class で既に定義済みのクラス/モジュールかどうか探索する際にトップレベル(cbase
が Object)の時だけ継承ツリーを辿って(include したモジュール内の定数も探索して)
、そこから再定義すべきクラス/モジュールを(あれば)取ってくるようにしています。
[ruby-core:39227] [Bug #5264]
うーん複雑な仕様ですね。チケットや追加されたテストでどういう定義が可能なのかわ
かりますが、定数の探索のルールと微妙に違っている(定数は見えるけど class/module
では新しいクラス/モジュールを作る)わけですね。
以下を実行してみるとわかると思います。
class A
  module X; end
end
class B < A
  p X               # => A::X
  module X; end     # ここで A::X の再定義ではなく B::X が定義される
  p X               # => B::X
end
