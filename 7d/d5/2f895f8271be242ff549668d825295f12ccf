Enumerator#flat_map はブロックが返した値をそのまま戻り値の配列に格納するのに、
Enumerator::Lazy#flat_map はその値に each を呼んで分解して格納するので、配列以
外のオブジェクト(Hash など)を返すと結果が変化してしまうのを防ぐ対処をしています
。といってもブロックの返すものがさらに Enumerator::Lazy オブジェクトだとその場
で配列化するのはよくないので、force と each が両方呼べることを rb_respond_to()
で確認してその時は each を、そうでなければ to_ary で配列に変換し、それもできな
ければそのままそのオブジェクトを格納するようにしています。 [ruby-core:51401]
[Bug #7690]
まあるりまを参照すると Enumerable#flat_map には「ブロックの返り値は基本的に配列
を返すべきです」と記述されてるので通常は配列を返しておくのが無難でしょう。
