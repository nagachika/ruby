Continuation に rb_ensure() で定義された ensure 節に相当する処理を終えた後でま
たその前の処理に戻った時に、ensure 節の処理を取り消す処理を実行させる機構を追加
して、これを利用して Hash#each の処理も修正しています。 callcc で Continuation
を生成した時にその時点で実行予定の ensure 処理を保持しておいて、ensure 処理で
rollback 用の関数を登録しておいて Continuation で処理を巻き戻したらその時点まで
rollback 処理を逆向きに実行して状態を元に戻すということをするみたいです。
[ruby-dev:47803] [Bug #9105]
いやーこれはおおごとですね。また ensure 処理が2重に実行してはいけない場合この
rollback 関数の登録に対応していないといけなくなるわけなので、拡張ライブラリでの
対応まで考えると、どうもそこまでする必要があるのかなぁという気も。 Ruby のスク
リプトで書かれた ensure 節の内容もこの対応とは別の問題ですしね。
