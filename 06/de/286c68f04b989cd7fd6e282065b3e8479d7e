配列のバッファ共有の仕組みに変更を加えて、共有している配列が1つだけの時の変更時
にバッファを再利用してメモリ確保を抑えるようなしくみが入れられています。ちょっ
とちゃんと読めているか不安ですが肝は共有している親の配列の length に capa (つま
りバッファ全体のサイズ)を入れておいて、rb_ary_modify() で内容を変更する時に可能
ならそのバッファをそのまま変更する配列で再利用するようにしています。この処理が
使えるかどうかの判定に共有数とサイズと共有バッファの capa との比較があるのです
が、このサイズの比較(capa >> 1 より大きい)というのは、サイズが減る場合はバッフ
ァを取り直したらメモリ効率が良くなるからという意味なんでしょうか。そうだとした
らここの係数はパラメータ化されてたほうがいいかも、と思いましたが bit shift でや
るのは実行速度のことを考えているのかもしれないですね。 [ruby-core:45818]
[Feature #6638]
あと ChangeLog のエントリに重複があるようです。
