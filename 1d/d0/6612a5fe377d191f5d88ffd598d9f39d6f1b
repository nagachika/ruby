Marshal.dump でインスタンス変数の dump の必要性の判定のために struct
RBasic::flags のエンコーディングのビットフラグをチェックしている部分で、
ENCODING_MASK の領域には freeze を表わすビットフラグと重複しているため freeze
したオブジェクトを dump しようとすると誤判定してしまって marshal_load でのロー
ド時に marshal_load を呼んだ後にインスタンス変数をセットしようとしてしまってい
たのを修正している、ようです。 dump する時の has_ivars をエンコーディングのビッ
トフラグチェックを省いたマクロを導入しているのですが、この時だけチェックを省い
ていいのはなぜなんでしょうか。freeze されてたら他のところでも誤判定は起きるよう
な気がするのですが。 [ruby-core:54334] [Bug #8276]
