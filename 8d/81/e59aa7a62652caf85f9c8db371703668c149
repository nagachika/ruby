標準添付ライブラリ cgi の CGI.escapeHTML でエスケープする文字ごとの変換を switch 文で分岐してたのを変換テーブルを用意してテーブルの参照に変更しています。また文字列バッファを都度文字列オブジェクトを作るのをやめて ALLOCA_N() で最初から全文字がエスケープされた場合を考慮して 6倍のサイズのバッファを用意しておくようにしています。 6倍確保かー。 https://github.com/ruby/ruby/pull/2226
