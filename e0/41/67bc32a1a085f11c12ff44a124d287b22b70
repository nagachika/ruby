rb_ivar_count() でオブジェクトのインスタンス変数毎のテーブルの名前とインデック
スの関係は同じクラスでは共有されているので、そのクラス毎のインスタンス変数の数
は拡張される可能性があるのですが、オブジェクト毎のインスタンス変数の数は別に管
理されているので、ROBJECT_IV_INDEX_TBL(obj)->num_entries を見てたため後から他の
インスタンスでインスタンス変数が追加されて拡張された場合に不正なメモリアクセス
をする可能性がありました。ROBJECT_NUMIV(obj) でインスタンス毎の上限のほうを使う
ように修正しています。
インスタンス変数の管理方法が今のようにクラス毎にインデックスを共有するようにな
ったのは結構前だったと思うのでおそらく 2.2, 2.3 でも修正が必要ですね。
[ruby-core:78403] [Bug #12988]
