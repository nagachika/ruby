ObjectSpace.reachable_objects_from というすてきなメソッドが追加されています。こ
れはオブジェクトを指定するとそのオブジェクトから参照しているオブジェクトを含ん
だ配列を返してくれるもものです(ただし RObject::klass が 0 にセットされている内
部的なオブジェクトは隠されています)。実装は GC 用の mark 処理を流用していて、
rb_objspace_t::mark_func_data というメンバに本来の mark 処理ではなくて別のコー
ルバックを呼ばせるおうな設定を格納できるようにしておいて、それを使うようにして
います。従って実際に GC した時にどのように mark されるかとほぼ一致するので、不
正な参照やあるはずの参照がなくなっているという GC にまつわるバグの調査に威力を
発揮しそうです。 [ruby-core:39772]
参照を取得中に(st_table に追加するので) GC が発生した時は一時的に
rb_objspace_t::mark_func_data を退避しておいて GC を実行するので本来の mark 処
理が実行されるので大丈夫となっています。
またいくつか小さな共通の処理を関数として切り出すリファクタリングもしています。
markable_object_p() に切りだしたのに同じ内容が展開されたままのところもあります
ね。
