恥ずかしながら知らなかったのですが Linux 2.6 以降ではシグナルハンドラで
SA_NOCLDWAIT というフラグを使うことができて、これを立てると子プロセスが終了した
時に親プロセスで wait しなくてもゾンビプロセスにならないという仕組みがあるそう
です。で実は ruby の SIGCHLD のデフォルトのハンドラはこれを使ってた(ということ
はたぶん昔このフラグを使ってるのを読んだことがあるはずなんだけど気がついてなか
った)のですが、これを使うと子プロセス終了時に親プロセスに SIGCHLD が送信される
かどうかは POSIX では未定義で、送信されなくなることもあるようなので、このフラグ
を使わずに SIGCHLD の処理で同じ挙動をするようにエミュレートさせるようにしている
ようです。エミュレート内容がこれでいいのかというのはちょっと謎ですが
(SA_NOCLDWAIT が指す挙動をちゃんと理解できてないのかも)。
