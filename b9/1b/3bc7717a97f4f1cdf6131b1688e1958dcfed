e8ae922b62adb00a80d3d4c49f7d7b0e6026eaba と 08de37f9fa3469365e6b5c964689ae2bae0eb9f3 で一旦入れられたけど(おそらく複数 Ractor 対応がされてなかったなどの理由で) 07f055bb132f21fd71af2720382ad8d2e8f69e47 ですぐに revert されたクラス変数の参照のインラインキャッシュ実装をリトライしています。 T_CLASS 型オブジェクトが持つ struct rb_classext_struct のメンバーに cvc_tbl というメンバーを追加してここにキャッシュしている値を保持するようです。キャッシュの invalidation には VM グローバルな通し番号で状態を保持しておいてこれが更新されてたら無効化するみたいですが、INC_GLOBAL_CVAR_STATE() というマクロが追加されているのにこれが呼ばれているところがないのが気になる。けどこのマクロを使わずに直接グローバル変数をインクリメントしてるコードはあるので、実際には無効化もしているみたいですね。 https://github.com/ruby/ruby/pull/4340
