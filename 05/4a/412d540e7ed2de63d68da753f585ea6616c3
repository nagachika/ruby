SIGCHLD のハンドリングを内部的に独自の処理を書いて、現在 wait 中の pid をリスト
で管理してそれに対して timer thread で waitpid を WNOHANG で呼び出して結果を通
知して起こす……みたいなことをしています。複雑になったなぁ。あと SIGCHLD はこれ
以前にもなにか特殊な扱いをしてたような気がするけど、何をしてるんだっけ……。憶
えてない。
これは MJIT でコンパイラのために子プロセスを起動するので Process.wait などがそ
の子プロセスにも反応してしまうという問題の回避のための処理みたいです。二重 fork
して worker 起動するためのプロセス作るのじゃ駄目なのかなぁ。これはこれで(バグが
なければ) SIGCHLD の取り漏らしがなくなっていいような気もするけど。
[ruby-core:87605] [Bug #14867]
