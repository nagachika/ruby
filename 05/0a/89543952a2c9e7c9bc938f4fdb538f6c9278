blocking fiber のための Scheduler を Thread に設定する時に必須なメソッド(block, unblock, kernel_sleep, io_wait) が定義されているか rb_respond_to() 関数でチェックするようにしています。 また rb_threadptr_join_list_wakeup() や rb_threadptr_unlock_all_locking_mutexes() で rb_thread_t::join_list や rb_thread_t::keeping_mutexes を辿る時に途中で例外が発生すると不正な要素をリストに残してしまうためか SEGV が発生するという不具合があったようなので先にリストから外してから処理するようにしています。また rb_threadptr_join_list_wakeup() と rb_threadptr_unlock_all_locking_mutexes() の呼び出しを  EC_EXEC_TAG() と EC_POP_TAG() の間に移動して、例外発生時の捕捉されるようにしています。 https://github.com/ruby/ruby/pull/4471
