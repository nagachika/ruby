r35480 でメインスレッドがスレッド切り替えばかりして処理本体に入れなくなる現象の
対処を別の方法で行なっています。起きていた現象については http://
bugs.ruby-lang.org/projects/ruby-trunk/wiki/R35480_ExtendedMemo にまとめられて
います。タイマースレッドとも関係していて、GVL 解放して別のスレッドに処理を明け
渡している状態のスレッドにタイマースレッドから割り込みフラグが立てられる可能性
があって、そのため GVL を再獲得しても直ぐにまた gvl_yield で別スレッドに譲って
しまうという現象のようです。これを避けるために rb_thread_t::yielding という構造
体メンバを追加して、gvl_yield() で GVL を明け渡し中のスレッドにはタイマー割り込
みがされないようにしています。
要はタイマー割り込みのフラグを rb_threadptr_execute_interrupts_common() の
ATOMIC_EXCHANGE() で読み取ってから次に再チェックするまでの間にまたタイマー割り
込みがあると延々このループで割り込み処理だけしてしまうということですね。
