Hash の実装である st_table の操作する関数群で hash や eql? メソッドを呼ぶために
Ruby のメソッド呼び出しを行うところで、Ruby の Thread のコンテキストスイッチが
おきる可能性があり、そこで別の Thread でループ中の Hash を操作するメソッドが呼
ばれて st_table のテーブルの再構築が行なわれると、SEGV などを起こす可能性があっ
た不具合を修正しています。 struct st_table には元々 rebuilds_num という rebuild
した回数を保持するメンバーがあったので、別 Thread が動いた可能性があるポイント
でそれをチェックして、変化していたら table->bins の取得からやりなおすように対応
をしています。なんか、すごく昔に Hash#each 中に要素を追加しようとするとエラーに
なるみたいなのを報告したような記憶がかすかにあるけど、いまだこんなのが残ってい
たとは。というか st.c の実装はちょっと前に高速化のため大きく変わったのでその時
に入り込んだのかも? [ruby-core:85510] [Bug #14357]
Hash#each 中に〜の話は http://d.hatena.ne.jp/nagachika/20100630/
ruby_hash_insert_during_marshal_dump これだった。なお後に(もう結構前)これは対応
されてエラーにならず後から追加できるようになったはず。たぶん Hash が順序保存す
るようになった後かな。
