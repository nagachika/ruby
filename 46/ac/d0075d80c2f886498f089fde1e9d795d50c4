組み込みメソッドなどを Ruby で実装するための仕組みの導入。 tool/mk_builtin_binary.rb というツールを追加して ruby で書かれたスクリプトを ISeq にコンパイルしてから to_binary でバイナリ表現にしたものを C コード片として ruby インタプリタに含めインタプリタ起動時にロードすることで ruby で書かれた定義を起動時に直接(parse/compile はスキップして)ロードするようにしています(miniruby の時点では起動時に動的に読み込んでる模様)。
また tool/mk_builtin_loader.rb というツールでこの ruby スクリプト内で "__builtin_" という prefix を持つメソッド呼び出しを含むものを抽出してテーブル化した C ソース片も生成して、__builtin_xxx というメソッド呼び出しはある C ソース内(生成された .inc ファイルを include したファイル内)の xxx という関数の呼び出しとして処理されるようにしています。このため rb_vm_t に rb_builtin_function というメンバーを追加して、現コンパイル中の ISeq から呼ばれる builtin function のテーブルを一時的にセットできるようにしています。このため VM 命令にも builtin func 呼び出しのための invokebuiltin と opt_invokebuiltin_delegate、opt_invokebuiltin_delegate_leave といった命令が追加されています。なので __builtin_xxx による C 関数の呼び出しは ruby 本体に埋め込むものでのみ有効で普通の ruby スクリプトから使えるものではありません。 [ruby-core:95344] [Feature #16254]
