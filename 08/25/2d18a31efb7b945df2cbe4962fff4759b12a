コンパイラの最適化で VALUE の変数が消されて GC の mark 漏れが生じるのを防ぐため
の RB_GC_GUARD() の改善をしています。元となるチケットは Solaris での不具合の報
告なので SolarisStudio での対応かと思いますが volatile なグローバル変数
rb_gc_guarded_val を導入して RB_GC_GUARD() が内部で使っている関数
rb_gc_guarded_ptr_val() (rb_gc_guarded_ptr() からこのコミットで改名)の中でこの
変数にも値を代入するようにしています。コメントによるとこれによってコンパイラに
この値がシグナルハンドラからも利用される可能性があると思わせることで最適化を防
ごうとしているとのこと。いやーコンパイラの最適化との終わりなき戦いですね。
[ruby-core:60816] [Bug #7805]
