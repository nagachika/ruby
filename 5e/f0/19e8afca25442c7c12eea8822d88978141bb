GC.compact による移動オブジェクトの統計情報を得る gc_compact_stats() という関数で struct RBasic::flags 内のオブジェクト型ごとにループする処理が 2度あったので共通のループにして内部で分岐を並べるようにしています。また移動が起きてなかったタイプのオブジェクトについて Hash にセットしないようにしています。これは GC.compact に未対応な型を含めないようにする意図のようですが、偶然 0 になった場合にキーがなくなるのでちょっと扱いずらくならないかな。
