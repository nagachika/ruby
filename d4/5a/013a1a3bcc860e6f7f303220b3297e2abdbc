メソッド呼び出し時の method entry の inline cache は cache miss して再探索しても結局 cache と同じ method entry になるというケースが多いらしいので、構造体 rb_call_cache のサイズを拡張して class_serial を配列にして古い class_serial も保持しておいて、メインの class_serial でのキャッシュが miss した時に過去の履歴もチェックしてひっかかったらこの class_serial を復活させて rb_call_cache::aux だけクリアしておくようにしています。 vm_search_method_fastpath() で class serial が古いのに戻ることってあるんだっけ…と思ったけど class serial は Class/Module ごとに最後に更新があった時の通し番号だから、対象の Class/Module が変更ないやつだったら戻ることはあるか。けどその場合 call cache の class_serial が一旦新しくなってるということは method entry も変わってるはずなので、どうやって以前の結果を使い回してるんだろう…。
