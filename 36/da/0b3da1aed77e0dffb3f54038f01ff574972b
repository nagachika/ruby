Thread の割り込みポイントを C 実装のメソッドや C実装のブロックから抜ける時にも入れるようにするため、vm_pop_frame() で常に RUBY_VM_CHECK_INTS() を呼ぶようにして、VM 命令の leave や throwobj 命令で呼んでたところはかわりに削っています。また Enumerable のメソッドでは C 実装のブロックの合間に割り込みポイントを作るため rb_thread_check_ints() を呼んでたのも不要になるので削っています。 これにより詳細な Thread の制御に影響するテストでこれに合わせてテストを修正しています。通常のプログラムは影響を受けないはずですが、これまで Thread の切り替えポイントになっていなかったところに依存した拡張ライブラリでの排他処理の省略をしてたりしたところはこれにより race condition とか Array のサイズが途中で変わりうるみたいな問題が発生する可能性があるかも。そういうのはたまたま動いてた、というべきなんだろうけど。 [ruby-core:95939] [Bug #16366]
