組込みクラス実装する ruby スクリプト内で使える __builtin_inline! というメソッドを追加して、引数の文字列内に直接 C の実装を書けるようにしています。ほえー、どうしてるのかと思ったら __builtin_inline{0,1,2,...} のような通し番号をつけた C の関数を生成して、この関数引数は ec と self のみで後は呼び元の ruby スクリプトでのメソッドの引数を rb_vm_lvar で参照してローカル変数として代入する文を定義する関数の先頭に挿入することで渡すようにしています。また __builtin_inline! の引数は文字列リテラルじゃないといけない?(putstring 命令のオペランドでないといけない)ようです。すごい。野心的な機能だなぁ。
