標準添付ライブラリ csv.rb で CSV#<< の実装で StringIO を利用している時にエンコ
ーディングの指定のために毎回新しい StringIO オブジェクトを生成しなおしていたの
で StringIO#set_encoding を利用するように書き直して CSV.generate が遅い問題に対
処しています。余分なオブジェクトを生成するだけでなく、String#force_encoding に
よりエンコーディングをセットすると coderange のキャッシュがクリアされて毎回エン
コーディングを意識した処理が必要となりとても時間がかかっていたそうです。
[ruby-core:55714] [Bug #8585]
