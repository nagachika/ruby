r43463 で導入した T_TYPEDATA の RUBY_TYPED_FREE_IMMEDIATELY フラグをさっそく利
用するようにしています。さっき記憶で書いたの解放処理を遅らせている原因は
[ruby-dev:35578] からのスレッドにあって、少し記憶が違っていて free 関数の処理か
ら Ruby の GVL を解放するような処理が走ると GC 中に動いてはいけない処理が動いて
しまうという問題を回避するためでした。 GC 中に実行しても問題ない処理しか呼ばな
い free 関数を登録する T_TYPEDDATA 型のオブジェクトは
RUBY_TYPED_FREE_IMMEDIATELY フラグをセットして GC 中に即座に解放処理も実行する
ようにしています。
